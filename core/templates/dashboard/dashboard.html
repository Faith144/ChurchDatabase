{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Church Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <h2>{{admin_profile.cell.}}</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshStats">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Messages Display -->
{% if messages %}
<div class="messages mb-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Search Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="position-relative">
                    <input type="text" class="form-control form-control-lg" 
                           id="globalSearch" placeholder="Search member's name, phone number, email..." 
                           autocomplete="off">
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4" id="quickStats">
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-primary text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="totalMembers">{{ total_members }}</h4>
                        <p class="mb-0">Total Members</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-success text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="activeMembers">{{ active_members }}</h4>
                        <p class="mb-0">Active Members</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-info text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="newMembersToday">{{ new_members_today }}</h4>
                        <p class="mb-0">New Today</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-plus fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-warning text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ total_families }}</h4>
                        <p class="mb-0">Families</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-home fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-warning text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ total_units }}</h4>
                        <p class="mb-0">Units</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-home fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-danger text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ total_assemblies }}</h4>
                        <p class="mb-0">Assemblies</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-church fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-secondary text-white stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ total_units }}</h4>
                        <p class="mb-0">Units</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-layer-group fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% if is_superadmin %}
    
<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-primary w-100 quick-action-btn" id="addMemberBtn">
                            <i class="fas fa-user-plus fa-2x mb-2"></i><br>
                            Add Member
                        </button>
                    </div>
                    <!-- <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-success w-100 quick-action-btn" id="addFamilyBtn">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            Add Family
                        </button>
                    </div> -->
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-success w-100 quick-action-btn" id="addUnitBtn">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            Add Unit
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-info w-100 quick-action-btn" id="addCell">
                            <i class="fas fa-home fa-2x mb-2"></i><br>
                            Add Cell
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-outline-warning w-100 quick-action-btn" id="addAssembly">
                            <i class="fas fa-church fa-2x mb-2"></i><br>
                            Add Assembly
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Members List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Members ({{members_count}})</h5>
                <div class="filter-section">
                    <select class="form-select form-select-sm me-2" id="assemblyFilter" style="width: auto; display: inline-block;">
                        <option value="">All Assemblies</option>
                        {% for assembly in assemblies %}
                        <option value="{{ assembly.id }}" {% if selected_assembly == assembly.id|stringformat:"i" %}selected{% endif %}>
                            {{ assembly.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <select class="form-select form-select-sm me-2" id="statusFilter" style="width: auto; display: inline-block;">
                        <option value="">All Status</option>
                        <option value="ACTIVE" {% if selected_status == "ACTIVE" %}selected{% endif %}>Active</option>
                        <option value="INACTIVE" {% if selected_status == "INACTIVE" %}selected{% endif %}>Inactive</option>
                        <option value="NEW_MEMBER" {% if selected_status == "NEW_MEMBER" %}selected{% endif %}>New Member</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Assembly</th>
                                <th>Cell</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            {% for member in members %}
                            <tr>
                                <td>
                                    <strong>{{ member.first_name }} {{ member.last_name }}</strong>
                                    {% if member.middle_name %}({{ member.middle_name }}){% endif %}
                                </td>
                                <td>{{ member.email|default:"-" }}</td>
                                <td>{{ member.phone|default:"-" }}</td>
                                <td>{{ member.assembly.name }}</td>
                                <td>{{ member.cell|default:"-" }}</td>
                                <td>
                                    <span class="badge {% if member.membership_status == 'ACTIVE' %}bg-success{% elif member.membership_status == 'NEW_MEMBER' %}bg-info{% else %}bg-warning{% endif %}">
                                        {{ member.membership_status }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-member" 
                                            data-member-id="{{ member.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning edit-member"
                                            data-member-id="{{ member.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-member"
                                            data-member-id="{{ member.id }}"
                                            data-member-name="{{ member.first_name }} {{ member.last_name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No members found</h5>
                                    <p class="text-muted">Try adjusting your filters or add a new member.</p>
                                    <button class="btn btn-primary" id="addMemberBtnEmpty">
                                        <i class="fas fa-user-plus me-1"></i>Add First Member
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Families
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Families</h5>
            </div>
            <div class="card-body">
                <div class="row" id="recentFamiliesContainer">
                    {% for family in recent_families %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">{{ family.family_name }}</h6>
                                <p class="card-text text-muted small">
                                    <i class="fas fa-church me-1"></i> {{ family.assembly.name }}<br>
                                    {% if family.phone %}<i class="fas fa-phone me-1"></i> {{ family.phone }}{% endif %}
                                    {% if family.email %}<br><i class="fas fa-envelope me-1"></i> {{ family.email }}{% endif %}
                                </p>
                                <button class="btn btn-sm btn-outline-primary view-family" 
                                        data-family-id="{{ family.id }}">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <p class="text-muted">No families found</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div> -->

{% endblock %}

{% block scripts %}
<script>
    // Toast notification function - MUST BE DEFINED FIRST
    function showToast(type, message) {
        // Remove any existing toasts first
        $('.toast').remove();
        
        const toast = $(`
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} border-0 position-fixed top-0 end-0 m-3" role="alert" style="z-index: 9999;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info'}-circle me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);
        
        $('body').append(toast);
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
        
        toast.on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    $(document).ready(function() {
        // Global Search Functionality
        let searchTimeout;
        $('#globalSearch').on('input', function() {
            const query = $(this).val();
            clearTimeout(searchTimeout);
            
            if (query.length >= 1) {
                searchTimeout = setTimeout(function() {
                    performSearch(query);
                }, 300);
            } else {
                $('#searchResults').hide().empty();
            }
        });

        function performSearch(query) {
            $.get('/ajax/search/', {q: query}, function(data) {
                displaySearchResults(data);
            }).fail(function(xhr, status, error) {
                console.error('Search failed:', error);
                showToast('error', 'Search failed. Please try again.');
            });
        }

        function displaySearchResults(data) {
            const resultsContainer = $('#searchResults');
            resultsContainer.empty();

            let hasResults = false;

            // Members
            if (data.members && data.members.length > 0) {
                hasResults = true;
                resultsContainer.append('<div class="p-2 border-bottom bg-light"><small class="text-muted fw-bold">MEMBERS</small></div>');
                data.members.forEach(member => {
                    resultsContainer.append(`
                        <a href="javascript:void(0)" class="dropdown-item view-member-search p-3" data-member-id="${member.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <strong class="d-block">${member.name}</strong>
                                    <small class="text-muted d-block">${member.email || 'No email'}</small>
                                    <small class="text-muted">${member.phone || 'No phone'}</small>
                                </div>
                                <span class="badge bg-primary ms-2">Member</span>
                            </div>
                        </a>
                    `);
                });
            }

            // // Families
            // if (data.families && data.families.length > 0) {
            //     hasResults = true;
            //     resultsContainer.append('<div class="p-2 border-bottom bg-light"><small class="text-muted fw-bold">FAMILIES</small></div>');
            //     data.families.forEach(family => {
            //         resultsContainer.append(`
            //             <a href="javascript:void(0)" class="dropdown-item view-family-search p-3" data-family-id="${family.id}">
            //                 <div class="d-flex justify-content-between align-items-center">
            //                     <div class="flex-grow-1">
            //                         <strong class="d-block">${family.name}</strong>
            //                         <small class="text-muted d-block">${family.email || 'No email'}</small>
            //                         <small class="text-muted">${family.phone || 'No phone'}</small>
            //                     </div>
            //                     <span class="badge bg-success ms-2">Family</span>
            //                 </div>
            //             </a>
            //         `);
            //     });
            // }

            if (!hasResults) {
                resultsContainer.append(`
                    <div class="p-3 text-center text-muted">
                        <i class="fas fa-search me-2"></i>No results found
                    </div>
                `);
            }

            resultsContainer.show();
        }

        // Close search results when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                $('#searchResults').hide();
            }
        });

        // View Member Details
        $(document).on('click', '.view-member, .view-member-search', function(e) {
            e.preventDefault();
            const memberId = $(this).data('member-id');
            showMemberDetails(memberId);
        });

        function showMemberDetails(memberId) {
            $.get(`/ajax/members/${memberId}/`, function(data) {
                $('#modalContainer').html(data.html);
                $('#memberDetailModal').modal('show');
            }).fail(function(xhr) {
                console.error('Failed to load member details:', xhr.responseText);
                showToast('error', 'Failed to load member details.');
            });
        }

        // Edit Member
        $(document).on('click', '.edit-member', function(e) {
            e.preventDefault();
            const memberId = $(this).data('member-id');
            loadMemberForm(memberId);
        });

        function loadMemberForm(memberId = null) {
            const url = memberId ? `/ajax/members/form/${memberId}/` : '/ajax/members/form/';
            
            $.get(url, function(data) {
                $('#modalContainer').html(data.html);
                $('#memberFormModal').modal('show');
            }).fail(function(xhr) {
                console.error('Failed to load member form:', xhr.responseText);
                showToast('error', 'Failed to load member form. Please try again.');
            });
        }

        // Add Member Button
        $('#addMemberBtn').click(function(e) {
            e.preventDefault();
            loadMemberForm();
        });

        // Delete Member
        $(document).on('click', '.delete-member', function(e) {
            e.preventDefault();
            const memberId = $(this).data('member-id');
            const memberName = $(this).data('member-name');
            showDeleteConfirmation(memberId, memberName, 'member');
        });

        function showDeleteConfirmation(objectId, objectName, objectType) {
            const message = `Are you sure you want to delete ${objectName}?`;
            const modalHtml = `
                <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-danger">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${message}
                                </p>
                                <p class="text-muted">This action cannot be undone.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" data-object-id="${objectId}" data-object-type="${objectType}">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#modalContainer').html(modalHtml);
            $('#deleteConfirmationModal').modal('show');

            // Handle delete confirmation
            $('#confirmDeleteBtn').on('click', function() {
                const objectId = $(this).data('object-id');
                const objectType = $(this).data('object-type');
                deleteObject(objectId, objectType);
            });
        }

        function deleteObject(objectId, objectType) {
            const url = `/ajax/${objectType}s/delete/${objectId}/`;
            
            $.ajax({
                url: url,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $('#deleteConfirmationModal').modal('hide');
                        showToast('success', response.message);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function(xhr) {
                    console.error('Delete failed:', xhr.responseText);
                    showToast('error', 'Failed to delete. Please try again.');
                }
            });
        }

        // View Family Details
        // $(document).on('click', '.view-family, .view-family-search', function(e) {
        //     e.preventDefault();
        //     const familyId = $(this).data('family-id');
        //     $.get(`/ajax/families/${familyId}/`, function(data) {
        //         $('#modalContainer').html(data.html);
        //         $('#familyDetailModal').modal('show');
        //     }).fail(function(xhr) {
        //         console.error('Failed to load family details:', xhr.responseText);
        //         showToast('error', 'Failed to load family details.');
        //     });
        // });

        // // Add Family Button
        // $('#addFamilyBtn').click(function(e) {
        //     e.preventDefault();
        //     loadFamilyForm();
        // });

        // function loadFamilyForm(familyId = null) {
        //     const url = familyId ? `/ajax/families/form/${familyId}/` : '/ajax/families/form/';
            
        //     $.get(url, function(data) {
        //         $('#modalContainer').html(data.html);
        //         $('#familyFormModal').modal('show');
        //     }).fail(function(xhr) {
        //         console.error('Failed to load family form:', xhr.responseText);
        //         showToast('error', 'Failed to load family form. Please try again.');
        //     });
        // }
        

        // Add Unit Button
        $('#addUnitBtn').click(function(e) {
            e.preventDefault();
            loadUnitForm();
        });

        function loadUnitForm(unitId = null) {
            const url = unitId ? `/ajax/units/form/${unitId}/` : '/ajax/units/form/';
            
            $.get(url, function(data) {
                $('#modalContainer').html(data.html);
                $('#unitFormModal').modal('show');
            }).fail(function(xhr) {
                console.error('Failed to load unit form:', xhr.responseText);
                showToast('error', 'Failed to load unit form. Please try again.');
            });
        }

        // Refresh Stats
        $('#refreshStats').click(function() {
            $.get('/ajax/quick-stats/', function(data) {
                $('#totalMembers').text(data.total_members);
                $('#activeMembers').text(data.active_members);
                $('#newMembersToday').text(data.new_members_today);
                showToast('success', 'Statistics updated successfully!');
            }).fail(function(xhr) {
                console.error('Failed to refresh stats:', xhr.responseText);
                showToast('error', 'Failed to refresh statistics.');
            });
        });

        // Filter members
        $('#assemblyFilter, #statusFilter').change(function() {
            applyFilters();
        });

        function applyFilters() {
            const assembly = $('#assemblyFilter').val();
            const status = $('#statusFilter').val();
            const url = new URL(window.location);
            
            if (assembly) url.searchParams.set('assembly', assembly);
            else url.searchParams.delete('assembly');
            
            if (status) url.searchParams.set('status', status);
            else url.searchParams.delete('status');
            
            window.location.href = url.toString();
        }

        // Add Cell Button
        $('#addCell').click(function(e) {
            e.preventDefault();
            loadCellForm();
        });

        function loadCellForm(cellId = null) {
            const url = cellId ? `/ajax/cells/form/${cellId}/` : '/ajax/cells/form/';
            
            $.get(url, function(data) {
                $('#modalContainer').html(data.html);
                $('#cellFormModal').modal('show');
            }).fail(function(xhr) {
                console.error('Failed to load cell form:', xhr.responseText);
                showToast('error', 'Failed to load cell form. Please try again.');
            });
        }

        // Add Assembly Button
        $('#addAssembly').click(function(e) {
            e.preventDefault();
            loadAssemblyForm();
        });

        function loadAssemblyForm(assemblyId = null) {
            const url = assemblyId ? `/ajax/assemblies/form/${assemblyId}/` : '/ajax/assemblies/form/';
            
            $.get(url, function(data) {
                $('#modalContainer').html(data.html);
                $('#assemblyFormModal').modal('show');
            }).fail(function(xhr) {
                console.error('Failed to load assembly form:', xhr.responseText);
                showToast('error', 'Failed to load assembly form. Please try again.');
            });
        }

        // Initialize quick stats
        function loadQuickStats() {
            $.get('/ajax/quick-stats/', function(data) {
                $('#newMembersToday').text(data.new_members_today || 0);
            }).fail(function() {
                console.error('Failed to load quick stats');
            });
        }

        loadQuickStats();
    });
</script>

<!-- Modal Container -->
<div id="modalContainer"></div>
{% endblock %}